<!DOCTYPE html>
<html lang="{{ lang or 'en' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="{{ description or site.description }}">
  <meta name="author" content="{{ site.author.name }}">

  <title>{{ title }} | {{ site.title }}</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/styles/main.css">

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">

  <!-- Syntax highlighting theme -->
  <link rel="stylesheet" href="/styles/syntax-theme.css">

  <!-- RSS Feed -->
  <link rel="alternate" type="application/atom+xml" title="{{ site.title }}" href="/feed.xml">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">

  <!-- Open Graph / Social Meta Tags -->
  <meta property="og:title" content="{{ title or site.title }}">
  <meta property="og:description" content="{{ description or site.description }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ site.url }}{{ page.url }}">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="{{ title or site.title }}">
  <meta name="twitter:description" content="{{ description or site.description }}">
</head>
<body>

  <!-- Header with navigation -->
  {% include "partials/header.njk" %}

  <!-- Main content -->
  <main class="main-content">
    {{ content | safe }}
  </main>

  <!-- Footer -->
  {% include "partials/footer.njk" %}

  <!-- hCaptcha -->
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>

  <!-- Theme switching script -->
  <script>
    // Initialize theme from localStorage or system preference
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

      document.documentElement.setAttribute('data-theme', theme);
    })();

    // Theme toggle and navigation functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle functionality
      const themeToggle = document.getElementById('theme-toggle');
      const footerThemeToggle = document.getElementById('footer-theme-toggle');

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }

      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }

      if (footerThemeToggle) {
        footerThemeToggle.addEventListener('click', toggleTheme);
      }

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
        }
      });

      // Hamburger menu functionality
      const hamburgerToggle = document.getElementById('hamburger-toggle');
      const mainNav = document.getElementById('main-nav');

      if (hamburgerToggle && mainNav) {
        // Helper function to close menu
        function closeMenu() {
          mainNav.classList.remove('nav-active');
          hamburgerToggle.classList.remove('active');
          hamburgerToggle.setAttribute('aria-expanded', 'false');
          mainNav.style.maxHeight = '0';
          releaseFocusTrap();
        }

        // Helper function to open menu
        function openMenu() {
          mainNav.classList.add('nav-active');
          hamburgerToggle.classList.add('active');
          hamburgerToggle.setAttribute('aria-expanded', 'true');
          // Dynamic max-height calculation
          mainNav.style.maxHeight = mainNav.scrollHeight + 'px';
          setupFocusTrap();
        }

        // Focus trap variables
        let focusableElements = [];
        let firstFocusableElement = null;
        let lastFocusableElement = null;

        // Setup focus trap
        function setupFocusTrap() {
          focusableElements = Array.from(mainNav.querySelectorAll(
            'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])'
          ));
          firstFocusableElement = focusableElements[0];
          lastFocusableElement = focusableElements[focusableElements.length - 1];

          // Focus first element when menu opens
          if (firstFocusableElement) {
            firstFocusableElement.focus();
          }
        }

        // Release focus trap
        function releaseFocusTrap() {
          focusableElements = [];
          firstFocusableElement = null;
          lastFocusableElement = null;
          // Return focus to hamburger button
          hamburgerToggle.focus();
        }

        // Handle Tab key for focus trap
        function handleFocusTrap(e) {
          if (!mainNav.classList.contains('nav-active')) return;
          if (e.key !== 'Tab') return;

          if (e.shiftKey) { // Shift + Tab (backwards)
            if (document.activeElement === firstFocusableElement) {
              e.preventDefault();
              lastFocusableElement.focus();
            }
          } else { // Tab (forwards)
            if (document.activeElement === lastFocusableElement) {
              e.preventDefault();
              firstFocusableElement.focus();
            }
          }
        }

        // Toggle menu on hamburger click
        hamburgerToggle.addEventListener('click', function() {
          const isActive = mainNav.classList.contains('nav-active');

          if (isActive) {
            closeMenu();
          } else {
            openMenu();
          }
        });

        // Close menu when clicking a navigation link
        const navLinks = mainNav.querySelectorAll('.nav-list a');
        navLinks.forEach(function(link) {
          link.addEventListener('click', function() {
            closeMenu();
          });
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
          const isClickInsideNav = mainNav.contains(event.target);
          const isClickOnHamburger = hamburgerToggle.contains(event.target);

          if (!isClickInsideNav && !isClickOnHamburger && mainNav.classList.contains('nav-active')) {
            closeMenu();
          }
        });

        // Close menu on Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && mainNav.classList.contains('nav-active')) {
            closeMenu();
          }
        });

        // Trap focus within menu when open
        document.addEventListener('keydown', handleFocusTrap);
      }
    });
  </script>

  <!-- Contact form handling -->
  <script src="/assets/js/contact.js"></script>

</body>
</html>
