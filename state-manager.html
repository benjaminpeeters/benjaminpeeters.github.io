<script>
// State Management for Language and Theme
// Manages language preferences and dark/light mode enhancements
(function() {
  'use strict';

  // ========== LANGUAGE STATE MANAGEMENT ==========

  // Detect current language from URL path
  function getCurrentLanguage() {
    const path = window.location.pathname;
    if (path.startsWith('/en/')) return 'en';
    if (path.startsWith('/fr/')) return 'fr';
    if (path.startsWith('/zh/')) return 'zh';
    return 'en'; // fallback
  }

  // Save language preference to localStorage
  function saveLanguagePreference(lang) {
    try {
      localStorage.setItem('quarto-language-preference', lang);
    } catch (e) {
      console.warn('Could not save language preference:', e);
    }
  }

  // Get saved language preference
  function getSavedLanguagePreference() {
    try {
      return localStorage.getItem('quarto-language-preference');
    } catch (e) {
      return null;
    }
  }

  // Detect browser's preferred language
  function getBrowserLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    if (browserLang.startsWith('fr')) return 'fr';
    if (browserLang.startsWith('zh')) return 'zh';
    return 'en';
  }

  // Update language dropdown to hide current language from menu
  function updateLanguageDropdown() {
    const currentLang = getCurrentLanguage();

    // Save current language preference
    saveLanguagePreference(currentLang);

    // Hide current language from dropdown menu
    const menuItems = document.querySelectorAll('.navbar-nav .dropdown-menu a[href*="index.html"]');
    menuItems.forEach(item => {
      const href = item.getAttribute('href');
      let itemLang = 'en';

      if (href.includes('/en/')) {
        itemLang = 'en';
      } else if (href.includes('/fr/')) {
        itemLang = 'fr';
      } else if (href.includes('/zh/')) {
        itemLang = 'zh';
      }

      // Hide the current language option from the menu
      if (itemLang === currentLang) {
        item.style.display = 'none';
      } else {
        item.style.display = '';
      }
    });
  }

  // Auto-redirect based on saved preference or browser language (first visit only)
  function handleLanguagePreference() {
    const currentLang = getCurrentLanguage();
    const savedLang = getSavedLanguagePreference();

    // Only handle redirects on homepage
    const isHomepage = window.location.pathname === '/' ||
                       window.location.pathname === '/index.html' ||
                       window.location.pathname.endsWith('/en/') ||
                       window.location.pathname.endsWith('/en/index.html') ||
                       window.location.pathname.endsWith('/fr/') ||
                       window.location.pathname.endsWith('/fr/index.html') ||
                       window.location.pathname.endsWith('/zh/') ||
                       window.location.pathname.endsWith('/zh/index.html');

    if (!isHomepage) {
      return;
    }

    // If no saved preference, check browser language on first visit
    if (!savedLang) {
      const browserLang = getBrowserLanguage();
      saveLanguagePreference(browserLang);

      // Redirect to browser's preferred language if not English
      if (browserLang !== 'en' && currentLang === 'en') {
        const hasRedirected = sessionStorage.getItem('quarto-lang-redirected');
        if (!hasRedirected) {
          sessionStorage.setItem('quarto-lang-redirected', 'true');
          const newPath = browserLang === 'fr' ? '/fr/index.html' : '/zh/index.html';
          window.location.href = newPath;
        }
      }
      return;
    }

    // If saved preference differs from current language, redirect
    if (savedLang !== currentLang) {
      const hasRedirected = sessionStorage.getItem('quarto-lang-redirected');
      if (!hasRedirected) {
        sessionStorage.setItem('quarto-lang-redirected', 'true');

        let newPath = '/en/index.html';
        if (savedLang === 'fr') newPath = '/fr/index.html';
        if (savedLang === 'zh') newPath = '/zh/index.html';

        window.location.href = newPath;
      }
    }
  }

  // Simple language switcher: strip current prefix, add target prefix
  function enhanceLanguageSwitcher() {
    // Find ALL links in the translate dropdown
    const langLinks = document.querySelectorAll('#nav-menu-bi-translate + .dropdown-menu a.dropdown-item');

    langLinks.forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();

        // Detect target language from link text
        const linkText = this.textContent.trim();
        let targetLang = 'en';
        if (linkText === 'Français') {
          targetLang = 'fr';
        } else if (linkText === '中文') {
          targetLang = 'zh';
        } else if (linkText === 'English') {
          targetLang = 'en';
        }

        // Get current language
        const currentLang = getCurrentLanguage();

        // Don't navigate if already on that language
        if (currentLang === targetLang) {
          return;
        }

        // Save language preference
        saveLanguagePreference(targetLang);

        // Language prefixes
        const prefixes = { en: 'en/', fr: 'fr/', zh: 'zh/' };

        // Get current page path without language prefix
        let pagePath = window.location.pathname.substring(1); // Remove leading /
        pagePath = pagePath.replace(/^(en\/|fr\/|zh\/)/, '');  // Strip language prefix

        // Build new URL with target language prefix
        const newPath = '/' + prefixes[targetLang] + pagePath;

        // Navigate to new path
        window.location.href = newPath;
      });
    });
  }

  // ========== THEME STATE ENHANCEMENTS ==========

  // Get current theme state from Quarto's localStorage
  function getCurrentTheme() {
    try {
      const storedTheme = localStorage.getItem('quarto-color-scheme');
      return storedTheme === 'alternate' ? 'dark' : 'light';
    } catch (e) {
      return 'light';
    }
  }

  // Add custom sun/moon icons for theme toggle
  function enhanceThemeToggle() {
    const toggle = document.querySelector('.quarto-color-scheme-toggle');
    if (!toggle) return;

    // Update toggle icon based on current theme
    function updateToggleIcon() {
      const theme = getCurrentTheme();
      const icon = toggle.querySelector('i.bi');
      if (icon) {
        // Remove existing icon classes
        icon.className = 'bi';
        // Add appropriate icon: sun when dark (to go light), moon when light (to go dark)
        if (theme === 'dark') {
          icon.classList.add('bi-sun-fill');
          toggle.setAttribute('title', 'Switch to light mode');
        } else {
          icon.classList.add('bi-moon-fill');
          toggle.setAttribute('title', 'Switch to dark mode');
        }
      }
    }

    // Update on page load
    updateToggleIcon();

    // Hook into Quarto's toggle function to update icon after toggle
    const originalToggle = window.quartoToggleColorScheme;
    if (originalToggle) {
      window.quartoToggleColorScheme = function() {
        originalToggle();
        // Small delay to allow Quarto's state to update
        setTimeout(updateToggleIcon, 50);
      };
    }
  }

  // ========== FOOTER POSITIONING ==========

  // Move custom footer outside #quarto-content for proper full-width positioning
  function repositionFooter() {
    const modernFooter = document.getElementById('modern-footer');
    const quartoContent = document.getElementById('quarto-content');
    const nativeFooter = document.querySelector('footer.footer');

    if (modernFooter && quartoContent) {
      // Move footer to be a direct child of body, after #quarto-content
      // If native footer exists, hide it
      if (nativeFooter) {
        nativeFooter.style.display = 'none';
      }

      // Insert after #quarto-content
      quartoContent.parentNode.insertBefore(modernFooter, quartoContent.nextSibling);
    }
  }

  // ========== INITIALIZATION ==========

  window.addEventListener('DOMContentLoaded', function() {
    // Initialize language features
    handleLanguagePreference();
    updateLanguageDropdown();
    enhanceLanguageSwitcher();

    // Initialize theme features
    enhanceThemeToggle();

    // Reposition footer for proper full-width layout
    repositionFooter();
  });

})();
</script>
